/**
 * KrisForm - Universal Form Library
 * Version: 2.2.1
 * Author: smalloff
 * Description: Secure, high-performance vanilla JS library for form validation, dependency management, and state handling.
*/
!function(e){"use strict";let t={EVENT_NAMESPACE:"krisform",ATTR:{PREFIX:"data-",VALIDATOR:"data-validator",FIELD:"data-field",CONTAINER:"data-field-container"}},i={updateDelay:10,selectors:{fieldContainers:["[data-field-container]","[id^='container_']",".field-container"],fields:["[name]","[data-field]",'input:not([type="hidden"])',"select","textarea"],feedback:".invalid-feedback",statusMessage:".field-status-message",statusText:".status-text",innerWrapper:".field-inner-wrapper"},classes:{disabled:["text-muted","opacity-50","pe-none"],required:["required-field"],hidden:["d-none"],invalid:["is-invalid"],valid:["is-valid"]},modalId:"dependencyConfirmModal",i18n:{defaultError:"Validation failed",confirmTitle:"Confirm Action",confirm:"Confirm",cancel:"Cancel"}},s={isVisible:e=>!!e&&!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length),debounce(e,t){let i;return function(...s){let l=this;clearTimeout(i),i=setTimeout(()=>e.apply(l,s),t)}},setText(e,t){e&&(e.textContent=t)},findFieldElements(e,t){if(!e)return[];let i=[`[name="${CSS.escape(t)}"]`,`#${CSS.escape(t)}`,`[data-field="${CSS.escape(t)}"]`],s=[];return i.forEach(t=>{let i=e.querySelectorAll(t);for(let l=0;l<i.length;l++)s.push(i[l])}),[...new Set(s)]},findFieldContainer(e,t){let i=t.selectors.fieldContainers.join(", ");return e.closest(i)},getFieldValue(e){if(!e||0===e.length)return null;if(1===e.length){let t=e[0];return"checkbox"===t.type?t.checked:"radio"===t.type?t.checked?t.value:null:t.value}let i=[],s=[],l=null;for(let a of e)"checkbox"===a.type?i.push(a):"radio"===a.type?s.push(a):l||"hidden"===a.type||(l=a);if(i.length>0)return i.length>1?i.filter(e=>e.checked).map(e=>e.value):i[0].checked;if(s.length>0){let n=s.find(e=>e.checked);return n?n.value:null}return l?l.value:e[0].value},setElementValue(e,t){if("checkbox"===e.type)e.checked=!0===t||"true"===t||1===t||"1"===t;else if("radio"===e.type){if(e.name){let i=document.getElementsByName(e.name);for(let s=0;s<i.length;s++)i[s].checked=i[s].value===String(t)}else e.checked=e.value===String(t)}else e.value=null==t?"":t}};class l{static evaluate(e,t,i,s){if(!e||"string"!=typeof e)return!1;try{let l={value:t,disabled:i("disabled"),readonly:i("readonly"),required:i("required"),visible:i("visible"),checked:i("checked")};return this._evaluateRecursive(e.trim(),l,s)}catch(a){return console.error("[KrisForm] Security/Parse Error in evaluator:",a),!1}}static _evaluateRecursive(e,t,i){for(;e.startsWith("(")&&e.endsWith(")");){let s=0,l=!0;for(let a=0;a<e.length-1;a++)if("("===e[a]?s++:")"===e[a]&&s--,0===s){l=!1;break}if(l)e=e.slice(1,-1).trim();else break}let n=this._findSplitIndex(e,"||");return -1!==n?this._evaluateRecursive(e.substring(0,n),t,i)||this._evaluateRecursive(e.substring(n+2),t,i):-1!==(n=this._findSplitIndex(e,"&&"))?this._evaluateRecursive(e.substring(0,n),t,i)&&this._evaluateRecursive(e.substring(n+2),t,i):this._evaluateAtom(e,t,i)}static _findSplitIndex(e,t){let i=0,s=t.length;for(let l=0;l<e.length;l++)if("("===e[l])i++;else if(")"===e[l])i--;else if(0===i&&e.substring(l,l+s)===t)return l;return -1}static _evaluateAtom(e,t,i){for(let s of(e=e.trim(),["===","!==","==","!=",">=","<=",">","<"])){let l=e.indexOf(s);if(-1!==l){let a=e.substring(0,l).trim(),n=e.substring(l+s.length).trim();return this._compare(this._resolve(a,t,i),this._resolve(n,t,i),s)}}for(let r of["includes","startsWith","endsWith"]){let d=`.${r}(`;if(e.includes(d))return this._evalMethod(e,t,r,i)}if(e.startsWith("Math.max(")||e.startsWith("max("))return this._evalMathFunction(e,"max",t,i);if(e.startsWith("Math.min(")||e.startsWith("min("))return this._evalMathFunction(e,"min",t,i);if(/[\+\-\*\/]/.test(e))return this._evalArithmetic(e,t,i);let o=this._resolve(e,t,i);return o}static _evalMathFunction(e,t,i,s){let l=e.substring(e.indexOf("(")+1,e.lastIndexOf(")")),a=l.split(",").map(e=>e.trim()),n=a.map(e=>this._evaluateRecursive(e,i,s)),r=n.map(e=>Number(e)||0);return"max"===t?Math.max(...r):"min"===t?Math.min(...r):0}static _evalArithmetic(e,t,i){let s=e.split("+");return s.length>1?s.reduce((e,s)=>e+(Number(this._resolve(s.trim(),t,i))||0),0):0}static _evalMethod(e,t,i,s){let l=e.split(`.${i}(`);if(l.length<2)return!1;let a=l[0].trim(),n=l[1].replace(/\)$/,"").trim(),r=this._resolve(a,t,s),d=this._resolve(n,t,s);return!!("string"==typeof r||Array.isArray(r))&&r[i](d)}static _compare(e,t,i){switch(i){case"===":return e===t;case"!==":return e!==t;case"==":return e==t;case"!=":return e!=t;case">=":return Number(e)>=Number(t);case"<=":return Number(e)<=Number(t);case">":return Number(e)>Number(t);case"<":return Number(e)<Number(t);default:return!1}}static _resolve(e,t,i){if((e=e.trim()).startsWith("'")&&e.endsWith("'")||e.startsWith('"')&&e.endsWith('"'))return e.slice(1,-1);if(!isNaN(Number(e))&&""!==e)return Number(e);if("true"===e)return!0;if("false"===e)return!1;if("null"===e)return null;if("undefined"!==e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e];if(e.startsWith("fields."))return i?i(e.slice(7).trim()):null;if(e.startsWith("source."))return t[e.slice(7)];if(e.includes(".")){let s=e.split(".");if(Object.prototype.hasOwnProperty.call(t,s[0])){let l=t[s[0]];for(let a=1;a<s.length;a++){let n=s[a];if("__proto__"===n||"constructor"===n||"prototype"===n||null==l)return null;l=l[n]}return l}}return null}}}class a{constructor(){let e=/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,t=/^(https?|ftp|file|git):\/\/[-a-zA-Z0-9+&@#/%?=~_|!:,.;]*[-a-zA-Z0-9+&@#/%=~_|]$/,i=/^[a-zA-Z][a-zA-Z0-9+.-]*:[a-zA-Z0-9%/?#:@&=+$,_.!~*'()]*$/,l=e=>{let t=0,i=!1;e=String(e).replace(/\D/g,"");for(let s=e.length-1;s>=0;s--){let l=parseInt(e.charAt(s));i&&(l*=2)>9&&(l-=9),t+=l,i=!i}return t%10==0},a=(e,t=0)=>{let i=/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,s=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/;return 4===t?i.test(e):6===t?s.test(e):i.test(e)||s.test(e)},n=(e,t=0)=>{let i=String(e).split("/");if(2!==i.length)return!1;let s=i[0],l=parseInt(i[1],10);return!isNaN(l)&&(4===t||0===t&&a(s,4)?a(s,4)&&l>=0&&l<=32:!!(6===t||0===t&&a(s,6))&&a(s,6)&&l>=0&&l<=128)},r=e=>{var t;let i=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return[{k:"2006",v:"\\d{4}"},{k:"06",v:"\\d{2}"},{k:"01",v:"\\d{2}"},{k:"02",v:"\\d{2}"},{k:"15",v:"\\d{2}"},{k:"03",v:"\\d{2}"},{k:"04",v:"\\d{2}"},{k:"05",v:"\\d{2}"},{k:"PM",v:"(?:AM|PM)"},{k:"MST",v:"[A-Z]{3}"},{k:"Z0700",v:"[+-]\\d{4}"}].forEach(e=>{i=i.replace(e.k,e.v)}),RegExp(`^${i}$`)},d=(e,t)=>{if(!e.form)return null;let i=s.findFieldElements(e.form,t);return s.getFieldValue(i)};this.rules={required:(e,t,i)=>"checkbox"===i.type?i.checked:"radio"===i.type?!!e:null!=e&&String(e).trim().length>0,required_with:(e,t,i)=>{let s=d(i,t);return!s||!(String(s).length>0)||this.rules.required(e,null,i)},required_without:(e,t,i)=>{let s=d(i,t);return!!s&&0!==String(s).length||this.rules.required(e,null,i)},eq:(e,t)=>String(e)===String(t),ne:(e,t)=>String(e)!==String(t),lt:(e,t)=>Number(e)<Number(t),gt:(e,t)=>Number(e)>Number(t),lte:(e,t)=>Number(e)<=Number(t),gte:(e,t)=>Number(e)>=Number(t),eqfield:(e,t,i)=>String(e)===String(d(i,t)),nefield:(e,t,i)=>String(e)!==String(d(i,t)),gtfield:(e,t,i)=>Number(e)>Number(d(i,t)),gtefield:(e,t,i)=>Number(e)>=Number(d(i,t)),ltfield:(e,t,i)=>Number(e)<Number(d(i,t)),ltefield:(e,t,i)=>Number(e)<=Number(d(i,t)),len:(e,t)=>String(e).length===Number(t),min:(e,t,i)=>("number"===i.type||"range"===i.type)?Number(e)>=Number(t):String(e).length>=Number(t),max:(e,t,i)=>("number"===i.type||"range"===i.type)?Number(e)<=Number(t):String(e).length<=Number(t),min_alpha:(e,t)=>(String(e).match(/[a-zA-Z]/g)||[]).length>=Number(t),min_lower:(e,t)=>(String(e).match(/[a-z]/g)||[]).length>=Number(t),min_upper:(e,t)=>(String(e).match(/[A-Z]/g)||[]).length>=Number(t),min_digit:(e,t)=>(String(e).match(/[0-9]/g)||[]).length>=Number(t),min_symbol:(e,t)=>(String(e).match(/[^a-zA-Z0-9\s]/g)||[]).length>=Number(t),alpha:e=>/^[a-zA-Z]+$/.test(e),alphanum:e=>/^[a-zA-Z0-9]+$/.test(e),alphaunicode:e=>/^[\p{L}]+$/u.test(e),alphanumunicode:e=>/^[\p{L}\p{N}]+$/u.test(e),numeric:e=>/^\d+$/.test(e),number:e=>!isNaN(Number(e))&&""!==e&&null!==e,hexadecimal:e=>/^[0-9a-fA-F]+$/.test(e),lowercase:e=>e===String(e).toLowerCase(),uppercase:e=>e===String(e).toUpperCase(),ascii:e=>/^[\x00-\x7F]+$/.test(e),print:e=>/^[\x20-\x7E]+$/.test(e),multibyte:e=>/[^\x00-\x7F]/.test(e),hexcolor:e=>/^#?([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(e),rgb:e=>/^rgb\(\s*(?:(?:\d{1,2}|1\d\d|2(?:[0-4]\d|5[0-5]))\s*,?){3}\)$/.test(e),rgba:e=>/^rgba\(\s*(?:(?:\d{1,2}|1\d\d|2(?:[0-4]\d|5[0-5]))\s*,?){3}\s*\s*(?:[0-9]*\.[0-9]+|[0-9]+)\)$/.test(e),hsl:e=>/^hsl\(\s*(?:\d+|\d*\.\d+)\s*,\s*(?:\d+|\d*\.\d+)%\s*,\s*(?:\d+|\d*\.\d+)%\s*\)$/.test(e),hsla:e=>/^hsla\(\s*(?:\d+|\d*\.\d+)\s*,\s*(?:\d+|\d*\.\d+)%\s*,\s*(?:\d+|\d*\.\d+)%\s*,\s*(?:[0-9]*\.[0-9]+|[0-9]+)\)$/.test(e),email:t=>e.test(t),email_list:t=>t.split(",").every(t=>e.test(t.trim())),email_domain:(e,t)=>String(e).toLowerCase().endsWith("@"+String(t).toLowerCase()),url:e=>t.test(e),uri:e=>i.test(e),urn_rfc2141:e=>/^urn:[a-zA-Z0-9]{1,31}:([a-zA-Z0-9()+,-.:=@;$_!*']|%[0-9a-fA-F]{2})+$/.test(e),http_url:e=>/^https?:\/\//.test(e)&&this.rules.url(e),url_encoded:e=>/^[^%]+$|^.*%[0-9a-fA-F]{2}.*$/.test(e),ip:e=>a(e),ipv4:e=>a(e,4),ipv6:e=>a(e,6),cidr:e=>n(e),cidrv4:e=>n(e,4),cidrv6:e=>n(e,6),mac:e=>/^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/.test(e),tcp_addr:e=>{let t=e.split(":"),i=parseInt(t.pop(),10),s=t.join(":");return(a(s)||this.rules.hostname(s))&&i>=0&&i<=65535},udp_addr:e=>this.rules.tcp_addr(e),hostname:e=>/^(?=.{1,253}$)(?:(?!-)[a-zA-Z0-9-]{1,63}(?<!-)\.)+[a-zA-Z]{2,63}$/.test(e),hostname_rfc1123:e=>/^(?=.{1,253}$)(?:(?!-)[a-zA-Z0-9-]{1,63}(?<!-)\.)*[a-zA-Z0-9]{1,63}$/.test(e),fqdn:e=>this.rules.hostname(e),e164:e=>/^\+[1-9]\d{1,14}$/.test(e),phone:e=>/^\+?(\d{1,3})?[-. (]*(\d{1,3})[-. )]*(\d{3})[-. ]*(\d{4})(?: *x(\d+))?$/.test(e),base64:e=>/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(e),base64url:e=>/^[A-Za-z0-9-_]+$/.test(e),datauri:e=>/^data:.+;base64,.+$/.test(e),magnet:e=>/^magnet:\?xt=urn:[a-z0-9]+:[a-z0-9]{32,40}&dn=.+&tr=.+$/.test(e),isbn:e=>/^(?:ISBN(?:-1[03])?:? )?(?=[0-9X]{10}$|(?=(?:[0-9]+[- ]){3})[- 0-9X]{13}$|97[89][0-9]{10}$|(?=(?:[0-9]+[- ]){4})[- 0-9]{17}$)(?:97[89][- ]?)?[0-9]{1,5}[- ]?[0-9]+[- ]?[0-9]+[- ]?[0-9X]$/.test(e),isbn10:e=>/^(?:ISBN(?:-10)?:? )?(?=[0-9X]{10}$|(?=(?:[0-9]+[- ]){3})[- 0-9X]{13}$)[0-9]{1,5}[- ]?[0-9]+[- ]?[0-9]+[- ]?[0-9X]$/.test(e),isbn13:e=>/^(?:ISBN(?:-13)?:? )?(?=[0-9]{13}$|(?=(?:[0-9]+[- ]){4})[- 0-9]{17}$)97[89][0-9]{1,5}[- ]?[0-9]+[- ]?[0-9]+[- ]?[0-9]$/.test(e),issn:e=>/^\d{4}-\d{3}[\dX]$/.test(e),uuid:e=>/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(e),uuid3:e=>/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-3[0-9a-fA-F]{3}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(e),uuid4:e=>/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-4[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/.test(e),uuid5:e=>/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-5[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/.test(e),latitude:e=>/^[-+]?([1-8]?\d(\.\d+)?|90(\.0+)?)$/.test(e),longitude:e=>/^[-+]?(180(\.0+)?|((1[0-7]\d)|([1-9]?\d))(\.\d+)?)$/.test(e),ssn:e=>/^\d{3}-\d{2}-\d{4}$/.test(e),semver:e=>/^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-((?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\.(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\+([0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?$/.test(e),json(e){try{return JSON.parse(e),!0}catch(t){return!1}},jwt:e=>/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(e),bic:e=>/^[A-Z]{6}[A-Z0-9]{2}([A-Z0-9]{3})?$/.test(e),credit_card:e=>l(e),btc_addr:e=>/^(1|3)[a-zA-Z1-9]{26,33}$/.test(e),btc_addr_bech32:e=>/^bc1[a-z0-9]{39,59}$/.test(e),eth_addr:e=>/^0x[a-fA-F0-9]{40}$/.test(e),datetime:(e,t)=>t?r(t).test(e):!isNaN(Date.parse(e)),timezone(e){try{return Intl.DateTimeFormat(void 0,{timeZone:e}),!0}catch(t){return!1}},contains:(e,t)=>String(e).includes(t),containsany:(e,t)=>[...String(t)].some(t=>String(e).includes(t)),notcontains:(e,t)=>!String(e).includes(t),excludes:(e,t)=>!String(e).includes(t),excludesall:(e,t)=>![...String(t)].some(t=>String(e).includes(t)),startswith:(e,t)=>String(e).startsWith(t),endswith:(e,t)=>String(e).endsWith(t),startsnotwith:(e,t)=>!String(e).startsWith(t),endsnotwith:(e,t)=>!String(e).endsWith(t),oneof:(e,t)=>t.split(/[, ]+/).includes(String(e)),neof:(e,t)=>!t.split(/[, ]+/).includes(String(e)),boolean:e=>["true","false","1","0"].includes(String(e).toLowerCase()),ext(e,t){if(!e)return!0;let i=String(e).split(".").pop().toLowerCase(),s=t.toLowerCase().split(";").map(e=>e.trim());return s.includes(i)},image:e=>this.rules.ext(e,"jpg;jpeg;png;gif;bmp;webp;svg;tiff;ico")},this.rules.ip=e=>this.rules.ipv4(e)||this.rules.ipv6(e),this.rules.iscolor=this.rules.hexcolor,this.rules.country_code=e=>/^[A-Z]{2}$/.test(e)}validate(e,t,i){if(!t)return{valid:!0};let s=t.split(",").map(e=>e.trim());for(let l of s){let a=l,n=null;l.includes("=")?[a,n]=l.split("="):l.includes(":")&&([a,n]=l.split(":"));let r=this.rules[a];if(!r)continue;let d=null===e||""===e||void 0===e,o=["required","required_with","required_without"].includes(a);if((o||!d)&&!r(e,n,i))return{valid:!1,failed:a,param:n}}return{valid:!0}}}class n{constructor(e,t={}){if(!e)throw Error("KrisForm: Element required");this.el=e,this.config=this._mergeConfig(t),this.dependencies=t.dependencies||[],this.validator=new a,this.state={isDirty:!1,initialValues:new Map,lastCommittedValues:new Map},this.dependencyMap=new Map,this.modal=null,this._handleInput=this._handleInput.bind(this),this._handleChange=this._handleChange.bind(this),this._handleFocusOut=this._handleFocusOut.bind(this),this._handleSubmit=this._handleSubmit.bind(this),this.init()}_mergeConfig(e){return{...i,...e,selectors:{...i.selectors,...e.selectors||{}},classes:{...i.classes,...e.classes||{}},i18n:{...i.i18n,...e.i18n||{}}}}init(){this._initModal(),this._groupDependencies(),this._snapshotState(),this._bindEvents(),this.updateAllDependencies(!0)}destroy(){this.el.removeEventListener("input",this._handleInput),this.el.removeEventListener("change",this._handleChange),this.el.removeEventListener("focusout",this._handleFocusOut),this.el.removeEventListener("submit",this._handleSubmit),this.state.initialValues.clear(),this.state.lastCommittedValues.clear(),this.dependencyMap.clear(),this.modal&&"function"==typeof this.modal.dispose&&this.modal.dispose()}_initModal(){let t=this.config.modalId||"dependencyConfirmModal",i=document.getElementById(t);if(!i)return;let s=i.querySelector(".modal-dialog")&&e.bootstrap&&e.bootstrap.Modal;if(s)try{this.modal=new e.bootstrap.Modal(i)}catch(l){console.warn("[KrisForm] Bootstrap init failed",l)}this.modal||(this.modal={show(){i.classList.add("show"),"none"===getComputedStyle(i).display&&(i.style.display="flex"),document.body.classList.add("modal-open")},hide(){i.classList.remove("show"),"flex"===i.style.display&&(i.style.display=""),document.body.classList.remove("modal-open")},dispose(){}})}_groupDependencies(){this.dependencies.forEach(e=>{let t=e.source.split(",").map(e=>e.trim());t.forEach(t=>{this.dependencyMap.has(t)||this.dependencyMap.set(t,[]),this.dependencyMap.get(t).push(e)})})}_snapshotState(){let e=this.el.querySelectorAll("input, select, textarea");for(let t of e)t.name&&"_csrf"!==t.name&&(this.state.initialValues.set(t,s.getFieldValue([t])),this.state.lastCommittedValues.has(t.name)||this.state.lastCommittedValues.set(t.name,this.getFieldValue(t.name)))}_bindEvents(){this.el.addEventListener("input",this._handleInput),this.el.addEventListener("change",this._handleChange),this.el.addEventListener("focusout",this._handleFocusOut),this.el.addEventListener("submit",this._handleSubmit)}_handleInput(e){let t=e.target;this._checkDirty(),t.matches("[data-validator]")&&this.validateField(t),t.name&&this.dependencyMap.has(t.name)&&this._processDependenciesForField(t.name,!1)}_handleChange(e){let t=e.target;this._checkDirty(),t.matches("[data-validator]")&&this.validateField(t),t.name&&this.dependencyMap.has(t.name)&&this._handleDependencyChange(t)}_handleFocusOut(e){let t=e.target;t.matches("[data-validator]")&&this.validateField(t)}_handleSubmit(e){this.validateAll()||(e.preventDefault(),e.stopPropagation(),this.scrollToError())}_checkDirty(){let e=!1;for(let[i,l]of this.state.initialValues.entries())if(document.body.contains(i)){let a=s.getFieldValue([i]);if(String(a)!==String(l)){if("file"===i.type&&i.classList.contains(this.config.classes.invalid[0]))continue;e=!0;break}}this.state.isDirty!==e&&(this.state.isDirty=e,this.el.dispatchEvent(new CustomEvent(t.EVENT_NAMESPACE+":dirty",{bubbles:!0,detail:{dirty:e}})))}validateField(e){let i="file"===e.type;if(!i&&(e.disabled||!s.isVisible(e)))return this.clearError(e),!0;let l=e.getAttribute(t.ATTR.VALIDATOR)||"";e.required&&!/(^|,)required($|,|:)/.test(l)&&(l=l?`required,${l}`:"required");let a=this._getElValue(e),n=this.validator.validate(a,l,e);return n.valid?(this.clearError(e),!0):(this.setError(e,n.failed,n.param),!1)}validateAll(){let e=!0,i=this.el.querySelectorAll(`[${t.ATTR.VALIDATOR}]`),s=Array.from(i);for(let l of s)this.validateField(l)||(e=!1);return e}setError(t,i,l){t.classList.add(...this.config.classes.invalid);let a=this._findFeedback(t);if(!a){(a=document.createElement("div")).className=this.config.selectors.feedback.replace(".","");let n=t.closest(".input-group")||t.parentElement;n.appendChild(a)}let r=e.KrisFormTranslateMessages||{},d=t.getAttribute(`data-msg-${i}`);d||(d=r[i]?r[i].replace("%s",l||""):r.default?r.default.replace("%s",i):`${this.config.i18n.defaultError}: ${i}`),s.setText(a,d),a.style.display="block"}clearError(e){e.classList.remove(...this.config.classes.invalid);let t=this._findFeedback(e);t&&(t.style.display="none")}scrollToError(){let e=this.el.querySelector(`.${this.config.classes.invalid[0]}`);e&&e.scrollIntoView({behavior:"smooth",block:"center"})}_findFeedback(e){let t=e.nextElementSibling,i=this.config.selectors.feedback.replace(".","");for(;t;){if(t.classList.contains(i))return t;t=t.nextElementSibling}return e.parentElement.querySelector(this.config.selectors.feedback)}_getElValue(e){return"checkbox"===e.type||"radio"===e.type?e.checked?e.value:"":e.value}_handleDependencyChange(t){let i=t.name,a=this.dependencyMap.get(i);if(!a)return;let n=this.getFieldValue(i),r=e=>this.getFieldState(i,e),d=e=>this.getFieldValue(e),o=null;for(let c of a)if(c.confirm&&l.evaluate(c.condition,n,r,d)){o=c.confirm;break}if(o){let u=this.config.modalId||"dependencyConfirmModal",h=document.getElementById(u),f=null,$=null,p=null;h?(f=h.querySelector(".confirm-message")||document.getElementById("dependencyConfirmMessage"),$=h.querySelector(".btn-confirm")||document.getElementById("btnConfirmOk"),p=h.querySelector(".btn-cancel")||document.getElementById("btnConfirmCancel")):(f=document.getElementById("dependencyConfirmMessage"),$=document.getElementById("btnConfirmOk"),p=document.getElementById("btnConfirmCancel"));let m=e.KrisFormTranslateMessages||{};if(f){let g=m[o]?m[o]:o;s.setText(f,g)}let _=()=>{this.state.lastCommittedValues.set(i,n),this._processDependenciesForField(i,!0),this._checkDirty(),A()},v=()=>{let e=this.state.lastCommittedValues.get(i);s.setElementValue(t,e),setTimeout(()=>this._processDependenciesForField(i,!0),0),A()},A=()=>{this.modal&&this.modal.hide(),$&&($.onclick=null),p&&(p.onclick=null)};this.modal&&h?($&&($.onclick=e=>{e.preventDefault(),_()}),p&&(p.onclick=e=>{e.preventDefault(),v()}),this.modal.show()):confirm(o)?_():v()}else this.state.lastCommittedValues.set(i,n),this._processDependenciesForField(i,!0)}_processDependenciesForField(e,t,i=!1){let a=this.dependencyMap.get(e);if(!a)return;let n=this.getFieldValue(e),r=t=>this.getFieldState(e,t),d=e=>this.getFieldValue(e);if(!t){for(let o of a)if(o.confirm&&l.evaluate(o.condition,n,r,d))return}a.forEach(e=>{if(!t&&e.confirm)return;let a=l.evaluate(e.condition,n,r,d);if(e.target){let o=e.target.split(",").map(e=>e.trim()).filter(Boolean);o.forEach(t=>{let l=s.findFieldElements(this.el,t);l.forEach(t=>{let l=s.findFieldContainer(t,this.config),r=a?e.action:e.inverse_action||this._getInverseAction(e.action),d=a&&e.time?parseInt(e.time,10):0;d>0?setTimeout(()=>{this._applyAction(t,l,r,n,i)},d):this._applyAction(t,l,r,n,i),e.message&&this._updateStatusMessage(l,e.message,a)})})}})}updateAllDependencies(e=!1){for(let[t]of this.dependencyMap.entries())this._processDependenciesForField(t,!0,e)}_applyAction(e,i,a,n,r=!1){if(!a)return;let[d,o]=a.split(":"),c=!s.isVisible(e),u={enable:()=>this._toggleFieldState(e,i,!0),disable:()=>this._toggleFieldState(e,i,!1),show:()=>this._toggleVisibility(e,i,!0),hide:()=>this._toggleVisibility(e,i,!1),required:()=>this._toggleRequired(e,i,!0,c),optional:()=>this._toggleRequired(e,i,!1,c),set_value:()=>!c&&s.setElementValue(e,o),check:()=>!c&&(e.checked=!0),uncheck:()=>!c&&(e.checked=!1),add_class:()=>i&&!c&&i.classList.add(...o.split(" ")),remove_class:()=>i&&!c&&i.classList.remove(...o.split(" ")),focus:()=>!c&&setTimeout(()=>e.focus(),50),clear:()=>!c&&s.setElementValue(e,""),filter_options:()=>this._filterOptions(e,n),set_computed_value:()=>{if(c)return;let t=e=>this.getFieldValue(e),i=l._evaluateRecursive(o,{value:n},t);s.setElementValue(e,i)}};u[d]&&(u[d](),["set_value","check","uncheck","clear"].includes(d)&&!c&&(e.dispatchEvent(new Event("change",{bubbles:!0})),e.dispatchEvent(new Event("input",{bubbles:!0}))),!r&&e.hasAttribute(t.ATTR.VALIDATOR)&&this.validateField(e))}_toggleFieldState(e,t,i){if(e.disabled=!i,t){let s=t.querySelector(this.config.selectors.innerWrapper)||t;i?(s.classList.remove(...this.config.classes.disabled),s.style.pointerEvents=""):s.classList.add(...this.config.classes.disabled)}}_toggleVisibility(e,t,i){t&&(i?(t.classList.remove(...this.config.classes.hidden),t.style.display="",t.hidden=!1):(t.classList.add(...this.config.classes.hidden),t.style.display="none",t.hidden=!0)),e.hidden=!i,i?e.style.display="":e.style.display="none"}_toggleRequired(e,t,i,s){s||(e.required=i),t&&(i?t.classList.add(...this.config.classes.required):t.classList.remove(...this.config.classes.required))}_filterOptions(e,t){if(!e||"SELECT"!==e.tagName)return;let i=[];t&&(i=(i=Array.isArray(t)?t:String(t).split(",").map(e=>e.trim())).map(String));let s=e.value,l=!1,a=null;for(let n=0;n<e.options.length;n++){let r=e.options[n],d=r.value,o=i.includes(d);o?(r.hidden=!1,r.disabled=!1,null===a&&(a=d),d===s&&(l=!0)):(r.hidden=!0,r.disabled=!0)}l||(e.value=null!==a?a:"",e.dispatchEvent(new Event("change",{bubbles:!0})))}_updateStatusMessage(t,i,s){if(!t)return;let l=t.querySelector(this.config.selectors.statusMessage);if(!l)return;let a=l.querySelector(this.config.selectors.statusText);if(s&&i){let n=e.KrisFormTranslateMessages||{};a&&(a.innerHTML=n[i]||i),l.classList.remove("d-none")}else a&&(a.innerHTML=""),l.classList.add("d-none")}_getInverseAction(e){return({enable:"disable",disable:"enable",show:"hide",hide:"show",required:"optional",optional:"required",readonly:"editable",editable:"readonly"})[e.split(":")[0]]||null}getFieldValue(e){let t=s.findFieldElements(this.el,e);return s.getFieldValue(t)}getFieldState(e,t){let i=s.findFieldElements(this.el,e);if(!i.length)return null;let l=i[0],a=i.filter(e=>"checkbox"===e.type);if(1===a.length)l=a[0];else{let n=i.find(e=>"hidden"!==e.type);n&&(l=n)}return"checked"===t?l.checked:"visible"===t?s.isVisible(l):"disabled"===t?l.disabled:"readonly"===t?l.readOnly:"required"===t?l.required:l.getAttribute(t)||l[t]}}e.KrisForm=n,e.KrisFormValidator=a,e.KrisFormEvaluator=l,e.KrisFormUtils=s,"undefined"!=typeof module&&module.exports&&(module.exports={KrisForm:n,Validator:a,Evaluator:l,Utils:s})}("undefined"!=typeof window?window:"undefined"!=typeof global?global:this);